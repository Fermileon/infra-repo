name: Infrastructure CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  terraform:
    name: Terraform FMT & Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

  k8s_lint:
    name: Kubernetes YAML Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y wget jq tar

      - name: Install kubeval
        run: |
          set -euo pipefail
          KVER=$(curl -s https://api.github.com/repos/instrumenta/kubeval/releases/latest | jq -r .tag_name)
          curl -Lo kubeval.tar.gz https://github.com/instrumenta/kubeval/releases/download/${KVER}/kubeval-linux-amd64.tar.gz
          tar -xzf kubeval.tar.gz
          chmod +x kubeval
          sudo mv kubeval /usr/local/bin/

      - name: Validate K8s Manifests
        run: kubeval k8s/*.yaml

  docker_build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Docker Image
        working-directory: docker
        run: docker build . -t test-image:ci

  ansible_check:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible

      - name: Ansible Syntax Check
        working-directory: ansible
        run: ansible-playbook playbook.yml --syntax-check

  argocd_validate:
    name: ArgoCD Manifest Validation
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y wget jq tar

    - name: Install kubeval
      run: |
        KVER=$(curl -s https://api.github.com/repos/instrumenta/kubeval/releases/latest | jq -r .tag_name)
        wget https://github.com/instrumenta/kubeval/releases/download/${KVER}/kubeval-linux-amd64.tar.gz -O kubeval.tar.gz
        tar -xzf kubeval.tar.gz
        chmod +x kubeval
        sudo mv kubeval /usr/local/bin/

    - name: Validate ArgoCD Manifests
      run: kubeval argocd/*.yaml
