name: Infrastructure CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  terraform:
    name: Terraform FMT & Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format Check
        working-directory: terraform
        run: terraform fmt -check

      - name: Terraform Init
        working-directory: terraform
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: terraform
        run: terraform validate

  k8s_lint:
    name: Kubernetes YAML Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install kubeval
        run: |
          curl -s https://api.github.com/repos/instrumenta/kubeval/releases/latest \
          | grep browser_download_url \
          | grep linux-amd64 \
          | cut -d '"' -f 4 \
          | wget -qi -
          chmod +x kubeval-*-linux-amd64
          sudo mv kubeval-*-linux-amd64 /usr/local/bin/kubeval

      - name: Validate K8s Manifests
        run: kubeval k8s/*.yaml

  docker_build:
    name: Docker Build Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Docker Image
        working-directory: docker
        run: docker build . -t test-image:ci

  ansible_check:
    name: Ansible Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Ansible
        run: sudo apt-get update && sudo apt-get install -y ansible

      - name: Ansible Syntax Check
        working-directory: ansible
        run: ansible-playbook playbook.yml --syntax-check

  argocd_validate:
    name: ArgoCD Manifest Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar -xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin

      - name: Validate ArgoCD Manifests
        run: kubeconform -strict -summary argocd/*.yaml
